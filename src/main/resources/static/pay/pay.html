<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>Оплата заказа</title>
        <script async src="https://pay.google.com/gp/p/js/pay.js" onload="onGooglePayLoaded()"></script>
    </head>

    <body>
        <div id="googlePayBtn"></div>

        <script>
            const tokenizationParameters = {
                tokenizationType: 'PAYMENT_GATEWAY',
                parameters: {
                    'gateway': 'example',
                    'gatewayMerchantId': 'abc123'
                }
            };
            const transactionInfo = {
                currencyCode: 'RUB',
                totalPriceStatus: 'FINAL',
                totalPrice: '1.00'
            }
            const allowedPaymentMethods = ["CARD", "TOKENIZED_CARD"];
            const allowedCardNetworks = ["MASTERCARD", "VISA"];
            let paymentsClient = null;

            function onGooglePayLoaded() {
                const paymentsClient = getGooglePaymentsClient();
                paymentsClient.isReadyToPay({allowedPaymentMethods: allowedPaymentMethods})
                    .then(function(response) {
                        if (response.result) {
                            addGooglePayButton();
                            prefetchGooglePaymentData();
                        }
                    })
                    .catch(function(err) {
                        console.error(err);
                    });
            }

            function getGooglePaymentsClient() {
                if (paymentsClient === null) {
                    paymentsClient = new google.payments.api.PaymentsClient({environment: 'TEST'});
                }
                return paymentsClient;
            }

            function addGooglePayButton() {
                const button = getGooglePaymentsClient().createButton({
                    onClick: onGooglePaymentButtonClicked,
                    buttonType: "short",
                    buttonColor: "black"
                });
                document.getElementById('googlePayBtn').appendChild(button);
            }

            function prefetchGooglePaymentData() {
                const paymentDataRequest = getGooglePaymentDataConfiguration();
                paymentDataRequest.transactionInfo = {
                    totalPriceStatus: 'NOT_CURRENTLY_KNOWN',
                    currencyCode: 'USD'
                };
                const paymentsClient = getGooglePaymentsClient();
                paymentsClient.prefetchPaymentData(paymentDataRequest);
            }

            function getGooglePaymentDataConfiguration() {
                return {
                    merchantId: "0123456789",
                    paymentMethodTokenizationParameters: tokenizationParameters,
                    allowedPaymentMethods: allowedPaymentMethods,
                    cardRequirements: {
                        allowedCardNetworks: allowedCardNetworks
                    },
                    emailRequired: true,
                    shippingAddressRequired: true
                };
            }

            function onGooglePaymentButtonClicked() {
                const paymentDataRequest = getGooglePaymentDataConfiguration();
                paymentDataRequest.transactionInfo = transactionInfo;

                const paymentsClient = getGooglePaymentsClient();
                paymentsClient.loadPaymentData(paymentDataRequest)
                    .then(paymentData => {
                        // получаем токен оплаты
                        console.log(paymentData.paymentMethodToken.token);
                    })
                    .catch(function(error) {
                        console.error(error);
                    });
            }
        </script>
    </body>
</html>